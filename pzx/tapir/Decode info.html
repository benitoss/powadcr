<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<meta name="keywords" content="TZX,ZX Spectrum,Speccy,Sinclair,tech,tape,format,specification">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>TZX technical specifications - Decode info</title></head>


<body alink="#ff0000" bgcolor="#ffffff" link="#0000ff" text="#000000" vlink="#800080">

<basefont face="Verdana" size="0">

<center id="INDEX">
<table bgcolor="#0040ff" border="0" width="50%">
<tbody><tr><td align="center"><font color="#ffff40" size="+4"><strong>TZX FORMAT</strong></font></td></tr>
</tbody></table>
</center>

<br>
This file contains a specification of the Custom info Decode info block as used by the TZX utility Tapir.
This type of block can be used in TZX revision 1.20 and above.
This specification should not be associated in any way with the official TZX file format specification.
<br>

<a name="CUSTOMBLOCK"></a>
<br>
<table align="center" bgcolor="#000000" border="0" cellpadding="2" cellspacing="1" width="70%">
<tbody><tr bgcolor="#80a0ff">
<td colspan="4" align="center"><strong><font color="#ffffff" size="+2">ID 35 - Custom info block</font></strong></td>
</tr>
<tr bgcolor="#fff000">
<td colspan="4" align="center"><strong><font color="#606060" size="-2">length: </font><font color="#ff6060" size="-2">[10,11,12,13]+14</font></strong></td>
</tr>
<tr bgcolor="#ffdf90">
<td align="center" width="8%"><strong>Offset</strong></td>
<td align="center" width="8%"><strong>Value</strong></td>
<td align="center" width="15%"><strong>Type</strong></td>
<td align="center"><strong>Description</strong></td>
</tr>
<tr bgcolor="#c0f0ff">
<td align="center">0x00</td>
<td align="center">-</td>
<td align="center">CHAR[10]</td>
<td>Identification string (in ASCII)</td>
</tr>
<tr bgcolor="#c0f0ff">
<td align="center">0x10</td>
<td align="center">L</td>
<td align="center">DWORD</td>
<td>Length of the custom info</td>
</tr>
<tr bgcolor="#c0f0ff">
<td align="center">0x14</td>
<td align="center">-</td>
<td align="center">BYTE[L]</td>
<td>Custom info</td>
</tr>
</tbody></table>

<br><br>
This block can be used to save any information you want. For example,
it might contain some information written by a utility, extra settings
required by a particular emulator, or even poke data.<br>
<br>
Some of the most common uses of this block have become standardized<br>
<br>

<center><strong><font size="+2">Decode info block</font></strong></center>
<br><br>This block allows a utility/emulator to correctly decode/interpret most of the datablocks it encounters,
provided that correct Decode info is specified.
<br><br>
<table align="center" bgcolor="#000000" border="0" cellpadding="2" cellspacing="1" width="70%">
<tbody><tr bgcolor="#ffc0c0">
<td align="center" width="8%"><strong>Offset</strong></td>
<td align="center" width="8%"><strong>Value</strong></td>
<td align="center" width="15%"><strong>Type</strong></td>
<td align="center"><strong>Description</strong></td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x00</td>
<td align="center">-</td>
<td align="center">CHAR[10]</td>
<td>"Decode info" + 5 spaces (custom block ID)</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x10</td>
<td align="center">-</td>
<td align="center">DWORD</td>
<td>Length of data that follow</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x14</td>
<td align="center">-</td>
<td align="center">BYTE</td>
<td>Flags: b0=RR L, b1=DEC IX, b2=group checksum</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x15</td>
<td align="center">-</td>
<td align="center">DWORD</td>
<td>Base address of the following datablock (-1 = not specified)</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x19</td>
<td align="center">-</td>
<td align="center">BYTE</td>
<td>Flag 'byte' length (-1 = use previous)</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x1A</td>
<td align="center">DSL</td>
<td align="center">DWORD</td>
<td>Decryption script length (-1 = use previous, 0 = none)</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x1E</td>
<td align="center">CL</td>
<td align="center">BYTE</td>
<td>Checksum length (-1 = use previous info, 0 = no checksum)</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x1F</td>
<td align="center">*</td>
<td align="center">DWORD</td>
<td>Checksum offset (>=0 ... offset from the start, <0 ... offset from the byte after the block, i.e. -1 = the last byte)</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x23</td>
<td align="center">*CSL</td>
<td align="center">DWORD</td>
<td>Checksum script length (0 = use standard XOR algorithm)</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x27</td>
<td align="center">*</td>
<td align="center">BYTE[CSL]</td>
<td>Checksum script</td>
</tr>
<tr bgcolor="#c0ffc0">
<td align="center">0x1F+<br>(CL>0)*(8+CSL)</td>
<td align="center">-</td>
<td align="center">BYTE[(DSL>0)*DSL]</td>
<td>Decryption script</td>
</tr>
</tbody></table>
<br><br>
The fields marked by an asterisk (*) are present only if CL>0.
<br>
If DSL>0 then set b1=0.
<br>
The fields explained:
<ul>
<li>
<b>Flags:</b>
<ul>
<li>b0=RR L ... The bytes are constructed from the bitstream by using the RR L instruction (rather that RL L, as usual), i.e. the bytes are 'flipped'.
(Example - Rick Dangerous 2)</li>
<li>b1=DEC IX ... The datablock is saved 'backwards', i.e. the loader uses DEC IX, instead of INC IX
(Example - Haxpoc-Lock scheme (Starwars))</li>
<li>b2=group checksum ... The checksum is computed over all the data in the enclosing Group statement.
This is useful, when the datablock is split into many subblocks, but they are still regarded by the loading routine as one big block.
(Example - Speedlocks)</li>
</ul>
</li>
<li>
<b>Flag 'byte' length</b> - how much bytes to skip before interpreting the data (Example - Gremlin 2 scheme (Basil the great mouse detective) has 3 bytes before the actual data)
</li>
<li>
<b>Checksum offset & length</b> - where to find a checksum in the datablock
</li>
<li>
<b>Checksum script</B> - A script for determining the checksum.
The script specifies the body of the following function:
<tt>function checksum(length:integer):integer;</tt><br>
where the parameter <tt>length</tt> is the length of the raw datablock in bytes rounded up to the nearest integer.
This function returns the computed checksum.
The source memory space for this function is the raw datastream, the destination memory space is void.
</li>
<li>
<b>Decryption script</b> - A script for decryption (or some other alteration) of the data.
The script specifies the body of the following function:
<tt>function decrypt(baseadr,length,lastbits:integer):integer;</tt><br>
where the parameter <tt>length</tt> is the length of the raw datablock in bytes rounded up to the nearest integer,
<tt>lastbits</tt> is the number of 'active' bits in the last byte.
This function returns the length of the decrypted data IN BITS!
The source memory space for this function is the raw datastream,
the destination memory space is a byte array, where the decrypted data should be constructed,
and its allocated size is Max(65536,<tt>length</tt>).
</li>
</UL>
The specification of the scripting language can be found in <a href="scripting language.txt">its own documentation</a>.
<br><br>
<b>Scope of the Decode info block:</b><br>
Base address value is effective only for the first datablock (i.e. ID 10, ID 11, ID 14, ID 19) encountered after the Decode info block, if there is no Group start or Group end between the Decode info and the datablock.
<br>
All other information:
<ul>
<li>
If not enclosed in the Group, the info is effective only for the first datablock (i.e. ID 10, ID 11, ID 14, ID 19) encountered after the Decode info block, if there is no Group start or Group end between the Decode info and the datablock.
</li>
<li>
If inside the Group, the info is effective until the end of the group or the next Decode info block, whichever comes first.
</li>
<li>
If 'group checksum' is selected (and it is inside the group), then the checksum info is effective for the datablocks starting after the Decode info block,
up to either the next Decode info or the Group end. However, the checksum is computed over the WHOLE enclosing Group.
</li>
<li>
The value "use previous" means that the information for this value should be taken from the previous Decode info block or default value if there is none.
</li>
</ul>

<br><br>
</body></html>
